<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>zounds</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5196 2007-06-03 20:25:28Z wiemann $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="zounds">
<h1 class="title">zounds</h1>

<p>'zounds' is a client-server setup for running many parallel commands
(typically BLAST) on clusters of computers.  It uses XML-RPC to
coordinate between the server &amp; clients.</p>
<p>The 'zounds-central' process runs on the server and serves both
configuration information and sequences to clients upon request.</p>
<p>The 'zounds-worker' processes must have access to the command (e.g.
'blastall' for BLAST, the search database(s) in question, and any code
you want to use for post-processing (e.g. the 'blastparser' Python
module).  All of the sequences and configuration information is
supplied by the server to the zounds-worker; all of the actual source
code needs to be on the client machine where zounds-worker runs.</p>
<div class="section" id="how-does-it-work">
<h1>How does it work?</h1>
<p>When you start 'zounds-worker', it contacts the 'zounds-central'
server and requests config info and a set of sequences.  It then runs
whatever command you've specified (e.g. BLAST) on the sequences
individually, with the configured parameters.  The results are then
optionally passed through some filter (e.g. parsed by blastparser) and
then pickled and returned to the server via XML-RPC.  The
'zounds-central' server saves the returned value as a record in a
'BsdDbShelf', with the sequence name as the key.</p>
<p>Because XML-RPC works via HTTP, and the clients contact the server,
the individual cluster machines need to be able to talk to the server
directly over the network.  However, the server never contacts the
clients so the cluster can be hidden behind a firewall, proxy, and/or
NAT.</p>
</div>
<div class="section" id="installing">
<h1>Installing</h1>
<p>You'll need to install <a class="reference external" href="http://www.python.org">Python</a>.</p>
<p>For the moment, you need to get zounds via 'git', at</p>
<pre class="literal-block">
git&#64;github.com:ctb/zounds.git
</pre>
<p>This can be done with 'git clone <a class="reference external" href="mailto:git&#64;github.com">git&#64;github.com</a>:ctb/zounds.git'.</p>
</div>
<div class="section" id="running-zounds-central">
<h1>Running 'zounds-central'</h1>
<p>Briefly,</p>
<pre class="literal-block">
python zounds-central &lt;config file&gt; &lt;config section&gt;
</pre>
<p>See 'config.rc' for examples.</p>
<p>For BLAST, the only trickiness is that the 'blastdb' must be a path
accessible to the 'zounds-worker' processes, while the 'sequences' and
'store_db' must be paths on the server.  This is because the sequences
are sent from the server to the client, and but the actual comparison
is done on the client.</p>
</div>
<div class="section" id="an-example">
<h1>An Example</h1>
<p>In one shell, run:</p>
<pre class="literal-block">
python zounds-central config-dev.rc test
</pre>
<p>In another shell, run:</p>
<pre class="literal-block">
python zounds-worker http://localhost:5678/
</pre>
<p>Once zounds-worker finishes, use CTRL-C to kill the server.</p>
<p>Now run:</p>
<pre class="literal-block">
python dump-raw-output test-output.db
</pre>
<p>You should get individual BLAST records for each of your query sequences,
almost as if you'd simply run 'blastall' locally.</p>
</div>
<div class="section" id="retrieving-results">
<h1>Retrieving results</h1>
<p>Use</p>
<p>Use</p>
<pre class="literal-block">
python -i load_db.py &lt;output filename&gt;
</pre>
<p>You'll now have a dictionary 'db' containing the keys (query sequences)
and values.</p>
<p>If you haven't specified a filter, then the values will be tuples:</p>
<pre class="literal-block">
(stdout, stderr)
</pre>
<p>from the BLAST output.</p>
<p>--</p>
<p><strong>Stupid note:</strong> that iterating over very large BsdDbShelf databases
is slow to start, because BsdDbShelf retrieves all of the keys at
once.  You can speed things up by using the raw bsddb database to
retrieve the keys into the shelf:</p>
<pre class="literal-block">
_db = btopen(store_db, 'r')
db = BsdDbShelf(_db)

for key in _db:
   value = db[key]
</pre>
</div>
<div class="section" id="using-filters">
<h1>Using filters</h1>
<p>Filters can be used both for parsing output and actual filtering of
results.</p>
<p>A 'filter' is specified in a config file as 'filter='; for example, in
config-dev.rc, section [test_filter],</p>
<pre class="literal-block">
filter=filters.parse_blast
</pre>
<p>wmakes each zounds-worker program import the module 'filters' and run
the function 'parse_blast' on the stdout and stderr of the subprocess
command; the result is then pickled and passed back to the server.</p>
<p>If the filter returns an empty record (None, or (), &quot;&quot;, or whatever)
then that too is pickled and returned.</p>
<div class="section" id="parsing-the-blast-results-with-filters-parse-blast">
<h2>Parsing the BLAST results with filters.parse_blast</h2>
<p>For this filter, the blastparser and parse_blast modules must be installed.</p>
<blockquote>
filter=filters.parse_blast</blockquote>
<p>After parsing, each record is a blastparser.BlastRecord, and you can
do something like this to get some basic results:</p>
<pre class="literal-block">
record = db[seq_name]
for hit in record:
   print hit.subject_name, hit.total_expect
</pre>
</div>
<div class="section" id="retrieving-only-a-subset-of-blast-results-with-filters-top-matches-only">
<h2>Retrieving only a subset of BLAST results with filters.top_matches_only</h2>
<p>Filters are useful for situations where you only need a small subset
of the information: e.g. rather than pickling and encoding a full
BLAST record, filters can reduce the full blastparser.BlastRecord to
something much smaller.</p>
<p>There's an example filter function in 'filters.py', function
'top_matches_only'.</p>
</div>
</div>
<div class="section" id="how-well-does-it-scale">
<h1>How well does it scale?</h1>
<p>I've BLASTed 200,000 sequences against the 'nr' database using 128
simultaneous workers, without any problems. In theory the disk and
network I/O should be the most time-consuming aspect of the server,
and since everything on the server side is threaded, I don't expect
there to be server-side performance issues.</p>
<p>On the client side there are likely to be a few performance problems:</p>
<blockquote>
<ol class="arabic simple">
<li>BLAST is run on each sequence individually, for simplicity's sake.
This means the BLAST database is reloaded for every BLAST.  This
could be optimized at the expense of a bit more code complexity
in 'zounds-worker'.</li>
<li>The worker submits the BLAST data to the server directly, without
starting a thread.  This means that if the server or network
is really busy, the worker may be network-bound.  (This should be
particularly easy to fix.)</li>
</ol>
</blockquote>
<p>None of these problems prevent zounds from working and so I just
ignore 'em.  You can fix them if you like.  Personally I'd prefer to
keep the worker code as simple as possible, but it should be fairly
easy to hack performance improvements in if you need or want them.</p>
</div>
<div class="section" id="author-info">
<h1>Author Info</h1>
<p>zounds was hacked together by C. Titus Brown, &lt;<a class="reference external" href="mailto:titus&#64;idyll.org">titus&#64;idyll.org</a>&gt;.  It is
freely available under the BSD license.</p>
</div>
<div class="section" id="acknowledgements">
<h1>Acknowledgements</h1>
<p>Tracy Teal and Qingpeng Zhang alpha- and beta-tested zounds.</p>
</div>
<div class="section" id="questions">
<h1>Questions?</h1>
<p>Please contact the <a class="reference external" href="http://lists.idyll.org/listinfo/biology-in-python">biology-in-python</a> mailing list with
any questions or comments about zounds.</p>
<p>--</p>
<p>TODO:</p>
<blockquote>
<ul class="simple">
<li>expand to HMMER</li>
<li>use sqlite shelve instead, for storage results</li>
<li>fix/work with screed v2</li>
<li>automatically set number of comparisons/seqs in db for BLAST and HMMER</li>
</ul>
</blockquote>
<p>--</p>
<p>CTB: Woods Hole MBL, 7/2008; MSU 3/2010.</p>
</div>
</div>
</body>
</html>
